<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Planos</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/admin.css" />
</head>
<body class="admin-bg">

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="card glass-card border-0 shadow-sm sidebar-card animate__animated animate__fadeInLeft">
        <div class="d-flex align-items-center gap-3">
          <div class="brand-badge"><i class="fa-solid fa-scissors"></i></div>
          <div>
            <div class="brand-title">thynkBarber</div>
            <div class="text-muted small">Painel administrativo</div>
          </div>
        </div>

        <div class="user-chip">
          <div class="label">Usuário:</div>
          <div class="value" id="adminUsername">carregando...</div>
        </div>

        <div class="side-sep"></div>

        <div class="side-subtitle">Navegação</div>
        <nav class="navlist">
          <a class="navitem" id="navDashboard" href="/dashboard.html">
            <i class="fa-solid fa-gauge-high"></i>
            <span>Dashboard</span>
          </a>
        </nav>

        <div class="side-subtitle">Gerenciamento</div>
        <nav class="navlist">
          <a class="navitem" href="/dashboard.html#barbearias">
            <i class="fa-solid fa-shop"></i>
            <span>Barbearias</span>
            <span class="ms-auto badge soft-badge">Em breve</span>
          </a>
          <a class="navitem active" id="navPlanos" href="/planos.html">
            <i class="fa-solid fa-layer-group"></i>
            <span>Planos</span>
          </a>
        </nav>

        <div class="mt-auto">
          <div class="side-sep"></div>
          <button id="btnLogout" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center gap-2">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>Sair do painel</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-area">
      <div class="card glass-card border-0 shadow-sm panel animate__animated animate__fadeInUp">
        <!-- Header -->
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
          <div>
            <h1 class="page-title mb-1">Gerenciamento de Planos</h1>
            <p class="page-sub">Aqui você gerencia e edita os planos ativos atualmente</p>
          </div>

          <button id="btnNewPlan" class="btn btn-primary d-flex align-items-center gap-2">
            <i class="fa-solid fa-plus"></i>
            <span>Adicionar Novo Plano</span>
          </button>
        </div>

        <hr class="my-3" style="opacity:.12;">

        <!-- Body: tabela full + gráficos embaixo -->
        <div class="row g-3">
          <!-- Tabela full -->
          <div class="col-12">
            <div class="card glass-card border-0 shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <i class="fa-solid fa-table-list text-primary"></i>
                    <strong>Planos cadastrados</strong>
                  </div>

                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge soft-badge" id="plansCount">0 planos</span>
                    <span class="badge soft-badge" id="activeCount">0 ativos</span>
                    <span class="badge soft-badge" id="activeInBarbearias">0 ativos em barbearias</span>
                  </div>
                </div>

                <div class="table-responsive" style="overflow-x:auto;">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr class="text-muted small">
                        <th style="min-width:100px;">Código</th>
                        <th style="min-width:180px;">Nome</th>
                        <th style="min-width:120px;">Criado em</th>
                        <th style="min-width:120px;">Expira em</th>
                        <th style="min-width:140px;">Responsável</th>
                        <th style="min-width:160px;">Permissões</th>
                        <th class="text-end" style="min-width:120px;">Ações</th>
                      </tr>
                    </thead>
                    <tbody id="plansTbody">
                      <tr>
                        <td colspan="7" class="text-muted">Carregando...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="mt-2 text-muted small">
                  Ações: <b>Editar</b> | <b>Ativar/Desativar</b> | <b>Excluir</b>
                </div>
              </div>
            </div>
          </div>

          <!-- Donut (embaixo à esquerda) -->
          <div class="col-12 col-xl-6">
            <div class="card glass-card border-0 shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-primary"></i>
                    <strong>Ativos por categoria</strong>
                  </div>
                </div>

                <div style="height: 260px; width:100%;">
                  <canvas id="donutChart"></canvas>
                </div>

                <div class="mt-3 text-muted small">
                  O gráfico considera <b>apenas planos ativos</b>.
                </div>
              </div>
            </div>
          </div>

          <!-- Line (à direita do donut) -->
          <div class="col-12 col-xl-6">
            <div class="card glass-card border-0 shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <i class="fa-solid fa-chart-line text-primary"></i>
                    <strong>Planos ativos no ano</strong>
                  </div>
                  <span class="badge soft-badge" id="activeYearBadge">Ano: —</span>
                </div>

                <div style="height: 260px; width:100%;">
                  <canvas id="lineChart"></canvas>
                </div>

                <div class="mt-3 text-muted small">
                  Contagem de <b>planos ativos</b> criados em cada mês do ano selecionado.
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Modal (3 steps) - MODAL MELHORADO -->
      <div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content glass-card border-0 shadow-lg">
            <div class="modal-header border-0 align-items-start">
              <div class="d-flex align-items-center gap-3">
                <div class="brand-badge"><i class="fa-solid fa-layer-group"></i></div>
                <div>
                  <h5 class="modal-title mb-0">Adicionar Novo Plano</h5>
                  <div class="text-muted small" id="stepHint">Step 01 • Dados do Plano</div>
                </div>
              </div>

              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body pt-0">
              <!-- Progresso -->
              <div class="modal-progress mb-3">
                <div class="progress" style="height: 10px;">
                  <div class="progress-bar" id="stepProgress" role="progressbar" style="width: 33%;"></div>
                </div>

                <div class="stepper mt-2">
                  <button type="button" class="stepper-item active" id="stepBtn1">
                    <span class="dot">1</span>
                    <span class="txt">
                      <b>Dados</b>
                      <small class="text-muted d-block">Nome, validade, valores</small>
                    </span>
                  </button>
                  <button type="button" class="stepper-item" id="stepBtn2">
                    <span class="dot">2</span>
                    <span class="txt">
                      <b>Permissões</b>
                      <small class="text-muted d-block">Áreas do sistema</small>
                    </span>
                  </button>
                  <button type="button" class="stepper-item" id="stepBtn3">
                    <span class="dot">3</span>
                    <span class="txt">
                      <b>Limites</b>
                      <small class="text-muted d-block">Regras por área</small>
                    </span>
                  </button>
                </div>
              </div>

              <div id="modalAlert" class="alert d-none" role="alert"></div>

              <div class="row g-3">
                <!-- Coluna esquerda: formulário -->
                <div class="col-12 col-lg-8">
                  <form id="planForm" autocomplete="off">
                    <!-- STEP 1 -->
                    <section id="step1" class="step-section">
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label">Nome do Plano</label>
                          <input class="form-control form-control-lg" name="name" required placeholder="Ex: Bronze / Pro" />
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label">Categoria (para gráficos)</label>
                          <input class="form-control form-control-lg" name="category" placeholder="Ex: Básico / Premium (opcional)" />
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label">Validade • Início</label>
                          <input type="date" class="form-control form-control-lg" name="startAt" required />
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label">Validade • Fim</label>
                          <input type="date" class="form-control form-control-lg" name="endAt" required />
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label">Responsável</label>
                          <input class="form-control form-control-lg" name="responsible" required placeholder="Ex: Arthur" />
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label">Quantidade de Planos (0 = infinito)</label>
                          <input type="number" min="0" class="form-control form-control-lg" name="planQtyLimit" value="0" />
                          <div class="form-text">Quando 0, este plano pode ser criado sem limite.</div>
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label">Valor</label>
                          <div class="input-group input-group-lg">
                            <span class="input-group-text">R$</span>
                            <input type="number" min="0" step="0.01" class="form-control" name="price" required placeholder="99.90" />
                          </div>
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label">Valor Promocional (opcional)</label>
                          <div class="input-group input-group-lg">
                            <span class="input-group-text">R$</span>
                            <input type="number" min="0" step="0.01" class="form-control" name="promoPrice" placeholder="79.90" />
                          </div>
                          <div class="form-text">Se vazio, não existe promoção.</div>
                        </div>
                      </div>
                    </section>

                    <!-- STEP 2 -->
                    <section id="step2" class="step-section d-none">
                      <div class="text-muted small mb-3">
                        Ative/desative as áreas que o plano terá acesso.
                      </div>

                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <div class="perm-card">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-bullseye text-primary"></i>
                                <b>Área de Metas</b>
                              </div>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="perm_metas" />
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Sem limitação.</small>
                          </div>
                        </div>

                        <div class="col-12 col-md-6">
                          <div class="perm-card">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-address-book text-primary"></i>
                                <b>Área de CRM</b>
                              </div>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="perm_crm" />
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Libera integrações selecionadas no Step 3.</small>
                          </div>
                        </div>

                        <div class="col-12 col-md-6">
                          <div class="perm-card">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-lightbulb text-primary"></i>
                                <b>Área de Inovação</b>
                              </div>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="perm_inovacao" />
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Sem limitação.</small>
                          </div>
                        </div>

                        <div class="col-12 col-md-6">
                          <div class="perm-card">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-graduation-cap text-primary"></i>
                                <b>Área de Educação</b>
                              </div>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="perm_educacao" />
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Sem limitação.</small>
                          </div>
                        </div>

                        <div class="col-12 col-md-6">
                          <div class="perm-card">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-headset text-primary"></i>
                                <b>Suporte Especializado</b>
                              </div>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="perm_suporteEspecializado" />
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Define acesso no Step 3.</small>
                          </div>
                        </div>

                        <div class="col-12 col-md-6">
                          <div class="perm-card">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-receipt text-primary"></i>
                                <b>Área de Assinaturas</b>
                              </div>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="perm_assinaturas" />
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Define limite no Step 3.</small>
                          </div>
                        </div>

                        <div class="col-12 col-md-6">
                          <div class="perm-card">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-diagram-project text-primary"></i>
                                <b>Área de Integrações</b>
                              </div>
                              <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="perm_integracoes" />
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Habilita/Desabilita no Step 3.</small>
                          </div>
                        </div>
                      </div>
                    </section>

                    <!-- STEP 3 -->
                    <section id="step3" class="step-section d-none">
                      <div class="text-muted small mb-3">
                        Configure regras e limites. As seções ficam disponíveis conforme as permissões do Step 2.
                      </div>

                      <!-- CRM Apps -->
                      <div class="card glass-card border-0 shadow-sm mb-3">
                        <div class="card-body">
                          <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="fa-solid fa-plug text-primary"></i>
                            <b>CRM • Apps permitidos</b>
                            <span class="ms-auto badge soft-badge" id="crmBadge">CRM desabilitado</span>
                          </div>

                          <div class="row g-2" id="crmAppsBox">
                            <div class="col-12 col-md-6">
                              <label class="w-100 navitem crm-app" style="cursor:pointer;">
                                <input class="form-check-input me-2" type="checkbox" name="crmApps" value="instagram">
                                <i class="fa-brands fa-instagram"></i><span>Instagram</span>
                              </label>
                            </div>
                            <div class="col-12 col-md-6">
                              <label class="w-100 navitem crm-app" style="cursor:pointer;">
                                <input class="form-check-input me-2" type="checkbox" name="crmApps" value="whatsapp">
                                <i class="fa-brands fa-whatsapp"></i><span>WhatsApp</span>
                              </label>
                            </div>
                            <div class="col-12 col-md-6">
                              <label class="w-100 navitem crm-app" style="cursor:pointer;">
                                <input class="form-check-input me-2" type="checkbox" name="crmApps" value="tiktok">
                                <i class="fa-brands fa-tiktok"></i><span>TikTok</span>
                              </label>
                            </div>
                            <div class="col-12 col-md-6">
                              <label class="w-100 navitem crm-app" style="cursor:pointer;">
                                <input class="form-check-input me-2" type="checkbox" name="crmApps" value="telegram">
                                <i class="fa-brands fa-telegram"></i><span>Telegram</span>
                              </label>
                            </div>
                          </div>

                          <div class="form-text mt-2">Disponível apenas se <b>CRM</b> estiver ativado.</div>
                        </div>
                      </div>

                      <!-- Suporte especializado -->
                      <div class="card glass-card border-0 shadow-sm mb-3">
                        <div class="card-body">
                          <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="fa-solid fa-headset text-primary"></i>
                            <b>Suporte Especializado</b>
                            <span class="ms-auto badge soft-badge" id="supportBadge">Desabilitado</span>
                          </div>
                          <select class="form-select" name="suporteEnabled" id="suporteEnabled">
                            <option value="0">Não possui</option>
                            <option value="1">Possui</option>
                          </select>
                          <div class="form-text mt-2">Disponível apenas se a permissão de suporte estiver ativa.</div>
                        </div>
                      </div>

                      <!-- Assinaturas -->
                      <div class="card glass-card border-0 shadow-sm mb-3">
                        <div class="card-body">
                          <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="fa-solid fa-receipt text-primary"></i>
                            <b>Assinaturas • Limite (0 = infinito)</b>
                            <span class="ms-auto badge soft-badge" id="subsBadge">Desabilitado</span>
                          </div>
                          <input type="number" min="0" class="form-control" name="assinaturasLimit" id="assinaturasLimit" value="0" />
                          <div class="form-text mt-2">Disponível apenas se a permissão de assinaturas estiver ativa.</div>
                        </div>
                      </div>

                      <!-- Integrações -->
                      <div class="card glass-card border-0 shadow-sm">
                        <div class="card-body">
                          <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="fa-solid fa-diagram-project text-primary"></i>
                            <b>Integrações</b>
                            <span class="ms-auto badge soft-badge" id="integrBadge">Desabilitado</span>
                          </div>
                          <select class="form-select" name="integracoesEnabled" id="integracoesEnabled">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                          </select>
                          <div class="form-text mt-2">Disponível apenas se a permissão de integrações estiver ativa.</div>
                        </div>
                      </div>
                    </section>
                  </form>
                </div>

                <!-- Coluna direita: resumo ao vivo -->
                <div class="col-12 col-lg-4">
                  <div class="card glass-card border-0 shadow-sm sticky-summary">
                    <div class="card-body">
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fa-solid fa-clipboard-check text-primary"></i>
                        <b>Resumo do Plano</b>
                      </div>

                      <div class="summary-block">
                        <div class="text-muted small">Nome</div>
                        <div class="fw-semibold" id="sumName">—</div>
                      </div>

                      <div class="summary-grid mt-2">
                        <div class="summary-block">
                          <div class="text-muted small">Categoria</div>
                          <div class="fw-semibold" id="sumCategory">—</div>
                        </div>
                        <div class="summary-block">
                          <div class="text-muted small">Responsável</div>
                          <div class="fw-semibold" id="sumResponsible">—</div>
                        </div>
                      </div>

                      <div class="summary-grid mt-2">
                        <div class="summary-block">
                          <div class="text-muted small">Início</div>
                          <div class="fw-semibold" id="sumStart">—</div>
                        </div>
                        <div class="summary-block">
                          <div class="text-muted small">Fim</div>
                          <div class="fw-semibold" id="sumEnd">—</div>
                        </div>
                      </div>

                      <div class="summary-grid mt-2">
                        <div class="summary-block">
                          <div class="text-muted small">Valor</div>
                          <div class="fw-semibold" id="sumPrice">—</div>
                        </div>
                        <div class="summary-block">
                          <div class="text-muted small">Promo</div>
                          <div class="fw-semibold" id="sumPromo">—</div>
                        </div>
                      </div>

                      <div class="summary-block mt-2">
                        <div class="text-muted small">Role (Cargo)</div>
                        <div class="fw-semibold" id="sumRole">ROLE_PLN_000X</div>
                        <div class="text-muted small mt-1" id="sumRoleName">Plano: — (PLN-000X)</div>
                      </div>

                      <div class="summary-block mt-3">
                        <div class="text-muted small mb-1">Permissões</div>
                        <div id="sumPerms" class="d-flex flex-wrap gap-1"></div>
                      </div>

                      <div class="text-muted small mt-3">
                        O código e role final serão gerados automaticamente ao salvar.
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <div class="modal-footer border-0">
              <button class="btn btn-outline-primary" id="btnPrev" type="button" disabled>
                <i class="fa-solid fa-arrow-left me-2"></i>Voltar
              </button>

              <button class="btn btn-primary" id="btnNext" type="button">
                Próximo <i class="fa-solid fa-arrow-right ms-2"></i>
              </button>

              <button class="btn btn-primary d-none" id="btnSave" type="button">
                <i class="fa-solid fa-floppy-disk me-2"></i>Salvar Plano
              </button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script src="/assets/js/admin-shell.js"></script>
  <script src="/assets/js/planos.js"></script>
</body>
</html>
